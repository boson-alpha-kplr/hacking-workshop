# KEBEROS EXPLOIT 

Le formulaire de réponse se trouve à l'emplacement suivant : 

                         https://forms.gle/mrGrzo4TtqFT4vfq9
                         
Ce workshop couvrira les bases de l'attaque de Kerberos, le service d'octroi de tickets Windows
nous couvrirons les points suivants :

- Enumération initiale à l'aide d'outils tels que Kerbrute et Rubeus
- Kerberoasting
- Roasting AS-REP avec Rubeus et Impacket
- Attaques SILVER et GOLDEN Ticket
- Pass the TIcket
- Attaques par clé squelette en utilisant mimikatz

Ce workshop est lié à des applications très réelles. 
Il vous donnera une excellente connaissance de départ sur la façon d'élever vos privilèges à un administrateur de domaine en attaquant Kerberos et vous permettra de prendre le contrôle d'un réseau.

###  Qu'est-ce que Kerberos ? (Rappel)

Kerberos est le service d'authentification par défaut pour les domaines Microsoft Windows. Il est destiné à être plus "sécurisé" que NTLM en utilisant une autorisation de ticket tiers ainsi qu'un cryptage plus fort. Même si NTLM a beaucoup plus de vecteurs d'attaque parmi lesquels choisir, Kerberos a encore une poignée de vulnérabilités sous-jacentes tout comme NTLM que nous pouvons utiliser à notre avantage.


- **Terminologie Kerberos**

**Ticket Granting Ticket (TGT)** - A ticket-granting ticket is an authentication ticket used to request service tickets from the TGS for specific resources from the domain.

**Key Distribution Center (KDC)** - The Key Distribution Center is a service for issuing TGTs and service tickets that consist of the Authentication Service and the Ticket Granting Service.

**Authentication Service (AS)** - The Authentication Service issues TGTs to be used by the TGS in the domain to request access to other machines and service tickets.

**Ticket Granting Service (TGS)** - The Ticket Granting Service takes the TGT and returns a ticket to a machine on the domain.

**Service Principal Name (SPN)** - A Service Principal Name is an identifier given to a service instance to associate a service instance with a domain service account. Windows requires that services have a domain service account which is why a service needs an SPN set.

**KDC Long Term Secret Key (KDC LT Key)** - The KDC key is based on the KRBTGT service account. It is used to encrypt the TGT and sign the PAC.

**Client Long Term Secret Key (Client LT Key)** - The client key is based on the computer or service account. It is used to check the encrypted timestamp and encrypt the session key.

**Service Long Term Secret Key (Service LT Key)** - The service key is based on the service account. It is used to encrypt the service portion of the service ticket and sign the PAC.

**Session Key** - Issued by the KDC when a TGT is issued. The user will provide the session key to the KDC along with the TGT when requesting a service ticket.

**Privilege Attribute Certificate (PAC)** - The PAC holds all of the user's relevant information, it is sent along with the TGT to the KDC to be signed by the Target LT Key and the KDC LT Key in order to validate the user.

- **AS-REQ avec pré-authentification**

L'étape AS-REQ de l'authentification Kerberos démarre lorsqu'un utilisateur demande un TGT au KDC. Afin de valider l'utilisateur et de créer un TGT pour l'utilisateur, le KDC doit suivre ces étapes exactes. La première étape consiste pour l'utilisateur à crypter un hachage d'horodatage NT et à l'envoyer à l'AS. Le KDC tente de déchiffrer l'horodatage à l'aide du hachage NT de l'utilisateur. En cas de succès, le KDC émettra un TGT ainsi qu'une clé de session pour l'utilisateur.

## CE QUI SUIT n'est pas un décor :tulip: Merci de BIEN LIRE :o)
### C'est important pour la compréhesion et l'exécution de l'attaque

- **Contenu du ticket d'octroi de billets (TGT)**

Afin de comprendre comment les tickets de service sont créés et validés, nous devons commencer par l'origine des tickets ; le TGT est fourni par l'utilisateur au KDC, en retour, le KDC valide le TGT et renvoie un ticket de service.

<img src ="https://i.imgur.com/kUqrVBa.png" width="50%" height="50%"/>

- **Contenu du ticket de Service**

Pour comprendre le fonctionnement de l'authentification Kerberos, vous devez d'abord comprendre ce que contiennent ces tickets et comment ils sont validés.  
Un ticket de service contient deux parties : la partie fournie par le service et la partie fournie par l'utilisateur.  


- **Portion service :**  
détails de l'utilisateur, clé de session, chiffré avec le hachage NTLM du compte de service.

- **Partie utilisateur :** 
horodatage de validité, clé de session, chiffré avec la clé de session TGT

<img src ="https://i.imgur.com/kUqrVBa.png" width="50%" height="50%"/>


**Aperçu des tickets Kerberos** 

- Le ticket principal que vous verrez est un ticket d'octroi de tickets qui peut se présenter sous diverses formes telles qu'un .kirbi pour Rubeus .ccache pour Impacket.   
- Le ticket principal que vous verrez est un ticket .kirbi.  
- Un ticket est généralement encodé en base64 et peut être utilisé pour diverses attaques.  
- Le ticket d'octroi de tickets est uniquement utilisé avec le KDC afin d'obtenir des tickets de service.  
- Une fois que vous avez donné le TGT, le serveur obtient les détails de l'utilisateur, la clé de session, puis crypte - le ticket avec le hachage NTLM du compte de service.   
- Votre TGT donne ensuite l'horodatage chiffré, la clé de session et le TGT chiffré.  
- Le KDC authentifiera alors le TGT et rendra un ticket de service pour le service demandé.  
- Un TGT normal ne fonctionnera qu'avec ce compte de service donné qui y est connecté, mais un KRBTGT vous permet d'obtenir n'importe quel ticket de service vous permettant d'accéder à n'importe quoi sur le domaine que vous voulez.

**Requis pour l'attaque de privilèges :**

- **Énumération Kerbrute** - Aucun accès au domaine requis
- **Pass the Ticket** - Accès en tant qu'utilisateur au domaine requis
- **Kerberoasting** - Accès comme n'importe quel utilisateur requis
- **Roasting AS-REP** - Accès comme n'importe quel utilisateur requis
- **Golden Ticket** - Compromis de domaine complet (administrateur de domaine) requis
- **Siver Ticket** - Service de hachage requis
- **Clé squelette** - Compromis de domaine complet (administrateur de domaine) requis


---

Questions : 

Que signifie TGT ?

```
reponse : 
```

Que signifie PAC ?
```
reponse : 
```

Quels sont les deux services qui composent le KDC ?

```
reponse : 
```

---

### ENUMERATION AVEC KERBRUTE

Kerbrute est un outil d'énumération populaire utilisé pour forcer et énumérer les utilisateurs valides de l'annuaire actif en abusant de la pré-authentification Kerberos.

Vous devez ajouter le nom de domaine DNS avec l'adresse IP de la machine à /etc/hosts à l'intérieur de votre machine attaquante ou ces attaques ne fonctionneront pas pour vous - MACHINE_IP CONTROLLER.local

Aperçu de l'abus de pré-authentification -

En brute forçant  la pré-authentification Kerberos, vous ne déclenchez pas l'événement d'échec de connexion du compte qui peut déclencher des drapeaux rouges pour les équipes défensives. 

Lors du brute-forcing via Kerberos, vous pouvez brute-forcer en n'envoyant qu'une seule trame UDP au KDC, ce qui vous permet d'énumérer les utilisateurs du domaine à partir d'une liste de mots.

**Installation de Kerbrute**

1.) Téléchargez un binaire précompilé pour votre système d'exploitation - 
https://github.com/ropnop/kerbrute/releases

2.) Renommez kerbrute_linux_amd64 en kerbrute

3.) ```chmod +x kerbrute``` - rendre Kerbrute exécutable

**Énumération des utilisateurs avec Kerbrute**

L'énumération des utilisateurs vous permet de savoir quels comptes d'utilisateurs se trouvent sur le domaine cible et quels comptes pourraient potentiellement être utilisés pour accéder au réseau.

1.) cd dans le répertoire où vous avez mis Kerbrute

2.) Téléchargez la liste de mots à énumérer ici

3.) ```./kerbrute userenum --dc CONTROLLER.local -d CONTROLLER.local User.txt ```
- Cela brute forcera les comptes d'utilisateurs d'un contrôleur de domaine à l'aide d'une liste de mots fournie

<img src="https://i.imgur.com/fSDrhyb.png"/>

**Exercice**

Énumérez maintenant par vous-même et trouvez le reste des utilisateurs et, plus important encore, les comptes de service.

**Répondre aux questions ci-dessous**

Combien d'utilisateurs au total dénombrons-nous ?
```
reponse : 
```
Quel est le nom du compte de service SQL ?
```
reponse : 
```
Quel est le deuxième nom de compte « machine » ?
```
reponse : 
```
Quel est le troisième nom de compte « utilisateur » ?
```
reponse : 
```

---

### Harvesting (Récolte) & Brute-Force avec RUBEUS


- Connectez vous à la machine cible : 

Nom d'utilisateur : Administrateur
Mot de passe : P@$$W0rd
Domaine :  controller.local

Rubeus est un outil puissant pour attaquer Kerberos. Rubeus est une adaptation de l'outil kekeo et développé par HarmJ0y le célèbre gourou de l'AD.

Rubeus possède une grande variété d'attaques et de fonctionnalités qui lui permettent d'être un outil très polyvalent pour attaquer Kerberos.  
Parmi les nombreux outils et attaques, citons le overpass the hash, les demandes et les renouvellements de tickets, la gestion des tickets, l'extraction de tickets, la collecte, le passage de ticket, l'AS-REP Roasting et le Kerberoasting.

L'outil a beaucoup trop d'attaques et de fonctionnalités pour que nous puissions toutes les couvrir.   
Nous ne traiterons donc que celles qui sont les plus cruciales pour comprendre comment attaquer Kerberos, mais je vous encourage à rechercher et à en savoir plus sur Rubeus et son ensemble d'attaques et de fonctionnalités ici : https://github.com/GhostPack/Rubeus

**Rubeus est déjà compilé et sur la machine cible.** :raised_hands:

**Récolte de Tickets avec Rubeus -**

La récolte rassemble les tickets qui sont transférés vers le KDC et les enregistre pour une utilisation dans d'autres attaques telles que l'attaque par pass de ticket.

1.) Téléchargements de cd - accédez au répertoire dans lequel se trouve Rubeus

2.) Rubeus.exe Harvest /interval:30 - Cette commande indique à Rubeus de récolter les TGT toutes les 30 secondes

<img src ="https://imgur.com/WN4zVo5.png"/>

**Brute-Forcing / Password-Spraying avec Rubeus**

- Rubeus peut à la fois des mots de passe de force brute ainsi que des comptes d'utilisateurs de spraying de mots de passe.  
- Lorsque vous forcez des mots de passe par force brute, vous utilisez un seul compte d'utilisateur et une liste de mots de passe pour voir quel mot de passe fonctionne pour ce compte d'utilisateur donné.  
- Lors du psarying, vous donnez un mot de passe unique tel que Password1 et "spray" contre tous les comptes d'utilisateurs trouvés dans le domaine pour trouver lequel peut avoir ce mot de passe.

- Cette attaque prendra un mot de passe basé sur Kerberos et le pulvérisera contre tous les utilisateurs trouvés et donnera un ticket .kirbi.  
- Ce ticket est un TGT qui peut être utilisé pour obtenir des tickets de service auprès du KDC ainsi que pour être utilisé dans des attaques comme l'attaque pass the ticket.

- Avant d'opérer le Password-Spraying avec Rubeus, vous devez ajouter le nom de domaine du contrôleur de domaine au fichier hôte Windows.  
- Vous pouvez ajouter l'IP et le nom de domaine au fichier hosts depuis la machine en utilisant la commande echo :

```echo MACHINE_IP CONTROLLER.local >> C:\Windows\System32\drivers\etc\hosts```

1.) ```cd Downloads``` - accédez au répertoire dans lequel se trouve Rubeus

2.) ```Rubeus.exe brute /password:Password1 /noticket``` - Cela prendra un mot de passe donné et le « pulvérisera » contre tous les utilisateurs trouvés, puis donnera le .kirbi TGT pour cet utilisateur

Soyez attentif à la façon dont vous utilisez cette attaque, car elle peut vous empêcher d'accéder au réseau en fonction des politiques de verrouillage de compte.

<img src ="https://imgur.com/VCeyyn9.png"/>

**Répondre aux questions ci-dessous**

Pour quel administrateur de domaine recevons-nous un ticket lors de la récolte des tickets ?
```
reponse : 
```
Pour quel contrôleur de domaine recevons-nous un ticket lors de la récolte des tickets ?
```
reponse : 
```

