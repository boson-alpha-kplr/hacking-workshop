# KEBEROS EXPLOIT 

Ce workshop couvrira les bases de l'attaque de Kerberos, le service d'octroi de tickets Windows
nous couvrirons les points suivants :

- Enumération initiale à l'aide d'outils tels que Kerbrute et Rubeus
- Kerberoasting
- Roasting AS-REP avec Rubeus et Impacket
- Attaques SILVER et GOLDEN Ticket
- Pass the TIcket
- Attaques par clé squelette en utilisant mimikatz

Ce workshop est lié à des applications très réelles. 
Il vous donnera une excellente connaissance de départ sur la façon d'élever vos privilèges à un administrateur de domaine en attaquant Kerberos et vous permettra de prendre le contrôle d'un réseau.

###  Qu'est-ce que Kerberos ? (Rappel)

Kerberos est le service d'authentification par défaut pour les domaines Microsoft Windows. Il est destiné à être plus "sécurisé" que NTLM en utilisant une autorisation de ticket tiers ainsi qu'un cryptage plus fort. Même si NTLM a beaucoup plus de vecteurs d'attaque parmi lesquels choisir, Kerberos a encore une poignée de vulnérabilités sous-jacentes tout comme NTLM que nous pouvons utiliser à notre avantage.


- **Terminologie Kerberos**

**Ticket Granting Ticket (TGT)** - A ticket-granting ticket is an authentication ticket used to request service tickets from the TGS for specific resources from the domain.

**Key Distribution Center (KDC)** - The Key Distribution Center is a service for issuing TGTs and service tickets that consist of the Authentication Service and the Ticket Granting Service.

**Authentication Service (AS)** - The Authentication Service issues TGTs to be used by the TGS in the domain to request access to other machines and service tickets.

**Ticket Granting Service (TGS)** - The Ticket Granting Service takes the TGT and returns a ticket to a machine on the domain.

**Service Principal Name (SPN)** - A Service Principal Name is an identifier given to a service instance to associate a service instance with a domain service account. Windows requires that services have a domain service account which is why a service needs an SPN set.

**KDC Long Term Secret Key (KDC LT Key)** - The KDC key is based on the KRBTGT service account. It is used to encrypt the TGT and sign the PAC.

**Client Long Term Secret Key (Client LT Key)** - The client key is based on the computer or service account. It is used to check the encrypted timestamp and encrypt the session key.

**Service Long Term Secret Key (Service LT Key)** - The service key is based on the service account. It is used to encrypt the service portion of the service ticket and sign the PAC.

**Session Key** - Issued by the KDC when a TGT is issued. The user will provide the session key to the KDC along with the TGT when requesting a service ticket.

**Privilege Attribute Certificate (PAC)** - The PAC holds all of the user's relevant information, it is sent along with the TGT to the KDC to be signed by the Target LT Key and the KDC LT Key in order to validate the user.

- **AS-REQ avec pré-authentification**

L'étape AS-REQ de l'authentification Kerberos démarre lorsqu'un utilisateur demande un TGT au KDC. Afin de valider l'utilisateur et de créer un TGT pour l'utilisateur, le KDC doit suivre ces étapes exactes. La première étape consiste pour l'utilisateur à crypter un hachage d'horodatage NT et à l'envoyer à l'AS. Le KDC tente de déchiffrer l'horodatage à l'aide du hachage NT de l'utilisateur. En cas de succès, le KDC émettra un TGT ainsi qu'une clé de session pour l'utilisateur.

## CE QUI SUIT n'est pas un décor. Merci de BIEN LIRE :o)
### C'est important pour la compréhesion et l'exécution de l'attaque

- **Contenu du ticket d'octroi de billets (TGT)**

Afin de comprendre comment les tickets de service sont créés et validés, nous devons commencer par l'origine des tickets ; le TGT est fourni par l'utilisateur au KDC, en retour, le KDC valide le TGT et renvoie un ticket de service.

<img src ="https://i.imgur.com/kUqrVBa.png"/>

- **Contenu du ticket de Service**

Pour comprendre le fonctionnement de l'authentification Kerberos, vous devez d'abord comprendre ce que contiennent ces tickets et comment ils sont validés.  
Un ticket de service contient deux parties : la partie fournie par le service et la partie fournie par l'utilisateur.  


- **Portion service :**  
détails de l'utilisateur, clé de session, chiffre le ticket avec le hachage NTLM du compte de service.

- **Partie utilisateur :** 
horodatage de validité, clé de session, chiffre avec la clé de session TGT

<img src ="https://i.imgur.com/kUqrVBa.png"/>


**Aperçu des tickets Kerberos** 

- Le ticket principal que vous verrez est un ticket d'octroi de tickets qui peut se présenter sous diverses formes telles qu'un .kirbi pour Rubeus .ccache pour Impacket.   
- Le ticket principal que vous verrez est un ticket .kirbi.  
- Un ticket est généralement encodé en base64 et peut être utilisé pour diverses attaques.  
- Le ticket d'octroi de tickets est uniquement utilisé avec le KDC afin d'obtenir des tickets de service.  
- Une fois que vous avez donné le TGT, le serveur obtient les détails de l'utilisateur, la clé de session, puis crypte - le ticket avec le hachage NTLM du compte de service.   
- Votre TGT donne ensuite l'horodatage chiffré, la clé de session et le TGT chiffré.  
- Le KDC authentifiera alors le TGT et rendra un ticket de service pour le service demandé.  
- Un TGT normal ne fonctionnera qu'avec ce compte de service donné qui y est connecté, mais un KRBTGT vous permet d'obtenir n'importe quel ticket de service vous permettant d'accéder à n'importe quoi sur le domaine que vous voulez.

**Requis de l'attaque de privilèges : **

- **Énumération Kerbrute** - Aucun accès au domaine requis
- **Pass the Ticket** - Accès en tant qu'utilisateur au domaine requis
- **Kerberoasting** - Accès comme n'importe quel utilisateur requis
- **Roasting AS-REP** - Accès comme n'importe quel utilisateur requis
- **Golden Ticket** - Compromis de domaine complet (administrateur de domaine) requis
- **Siver Ticket** - Service de hachage requis
- **Clé squelette** - Compromis de domaine complet (administrateur de domaine) requis
